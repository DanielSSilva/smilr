#
# Azure Pipelines
# - Deploy to Kubernetes (AKS) using Helm chart
# Ben C, 2019
#

trigger: none

# NOTE! This variable group must be pre-created and populated
# - Expected variables: acr-name, acr-password, azure-sub, aks-resgrp, aks-cluster
variables:
  - group: shared-variables

stages:
#
# Deploy stage 1 - AKS test environment
#
- stage: deployToTest
  displayName: Deploy to AKS Test
  
  variables:
    dns-name: 'smilr.56539f01234e4e00981e.westeurope.aksapp.io'

  jobs:
  - deployment: deployToTest
    environment: 'AKS Test'

    pool:
      vmImage: Ubuntu-16.04

    strategy:
      runOnce:
        deploy:
          steps:
          - checkout: self

          - task: HelmInstaller@1
            displayName: 'Install Helm Version'
            inputs:
              helmVersionToInstall: 2.12.3
          
          - task: HelmDeploy@0
            displayName: 'Helm Update Dependencies'
            inputs:
              azureSubscriptionEndpoint: $(azure-sub)
              azureResourceGroup: $(aks-resgrp)
              kubernetesCluster: $(aks-cluster)
              command: dependency
              arguments: 'update kubernetes/helm/smilr'

          - task: HelmDeploy@0
            displayName: 'Helm Install/Upgrade Smilr'
            inputs:
              azureSubscriptionEndpoint: $(azure-sub)
              azureResourceGroup: $(aks-resgrp)
              kubernetesCluster: $(aks-cluster)
              namespace: default
              command: upgrade
              chartType: FilePath
              chartPath: 'kubernetes/helm/smilr'
              releaseName: 'test'
              overrideValues: 'registryPrefix=$(acr-name).azurecr.io/,domainSuffix=$(dns-name),dataApi.imageTag=latest,frontend.imageTag=latest,mongo.usePersistence=false'              