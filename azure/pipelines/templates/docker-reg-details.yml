parameters:
  filter: 'azurecr.io'

steps:
  # Login to ACR
  - task: Docker@2
    displayName: Login to ACR
    inputs:
      command: login
      containerRegistry: $(acr-connection) 

  # Extract registry connection details as variables for next step
  - bash: |
      registry=$(cat $DOCKER_CONFIG/config.json | jq -r '.auths | with_entries( select(.key|contains("azurecr.io")) ) | keys[0]')
      secret=$(cat $DOCKER_CONFIG/config.json | jq -r '.auths | with_entries( select(.key|contains("azurecr.io")) ) [].auth' | python -m base64 -d)
      user=$(echo $secret | awk -F':' '{print $1}')
      password=$(echo $secret | awk -F':' '{print $2}')

      echo "##vso[task.setvariable variable=DOCKER_REG]$registry"
      echo "##vso[task.setvariable variable=DOCKER_USER]$user"
      echo "##vso[task.setvariable variable=DOCKER_PASSWORD]$password"
    displayName: Extract Docker registry details