resources:
  - repo: self

queue:
  name: Hosted Ubuntu 1604


variables:
  - name: acr-name
    value: bcdemo
  - name: acr-res-group
    value: Demo.Containers

steps:
- task: Docker@1
  displayName: 'Build image from data-api/Dockerfile'
  inputs:
    azureSubscriptionEndpoint: 'Azure (AIRS)'

    azureContainerRegistry: '{"loginServer":"$(acr-name).azurecr.io", "id" : "/subscriptions/52512f28-c6ed-403e-9569-82a9fb9fec91/resourceGroups/$(acr-res-group)/providers/Microsoft.ContainerRegistry/registries/$(acr-name)"}'

    dockerFile: 'node/data-api/Dockerfile'

    arguments: '--build-arg build_info="Azure DevOps build: ''$(Build.BuildNumber)' Trigger: '$(Build.Reason)'. Built as container image"'

    useDefaultContext: false

    buildContext: .

    imageName: 'smilr/data-api:$(Build.BuildNumber)'

    includeSourceTags: true

    includeLatestTag: true


- task: Docker@1
  displayName: 'Push image to ACR'
  inputs:
    azureSubscriptionEndpoint: 'Azure (AIRS)'

    azureContainerRegistry: '{"loginServer":"bcdemo.azurecr.io", "id" : "/subscriptions/52512f28-c6ed-403e-9569-82a9fb9fec91/resourceGroups/Demo.Containers/providers/Microsoft.ContainerRegistry/registries/bcdemo"}'

    command: 'Push an image'

    imageName: 'smilr/data-api'


- script: 'docker tag $(acr-name).azurecr.io/smilr/data-api:latest smilr/data-api:latest'
  displayName: 'Tag latest for Dockerhub'

- task: Docker@1
  displayName: 'Push image to Dockerhub'
  inputs:
    containerregistrytype: 'Container Registry'

    dockerRegistryEndpoint: Dockerhub

    command: 'Push an image'

    imageName: 'smilr/data-api:latest'


